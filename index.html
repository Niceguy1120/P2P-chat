<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>P2P Chat System</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #e5ddd5;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #login-overlay {
            position: fixed;
            inset: 0;
            background: #075e54;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 300px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .hidden {
            display: none !important;
        }

        #header {
            background: #075e54;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
        }

        #chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg {
            padding: 10px;
            border-radius: 8px;
            max-width: 70%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .sent {
            align-self: flex-end;
            background: #dcf8c6;
        }

        .rcvd {
            align-self: flex-start;
            background: white;
        }

        #controls {
            padding: 15px;
            background: #f0f0f0;
            display: flex;
            gap: 10px;
            border-top: 1px solid #ddd;
        }

        input,
        select {
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ccc;
            outline: none;
        }
    </style>
</head>

<body>
    <div id="login-overlay">
        <div class="card">
            <h2 style="text-align:center; color:#075e54">P2P Login</h2>
            <input type="text" id="u-in" placeholder="Username">
            <input type="password" id="p-in" placeholder="Passphrase proposal">
            <button onclick="login()"
                style="padding:10px; background:#128c7e; color:white; border:none; border-radius:20px; cursor:pointer;">VÀO
                CHAT</button>
        </div>
    </div>

    <div id="main-app" class="hidden" style="display:flex; flex-direction:column; height:100%;">
        <div id="header">
            <span id="user-display"></span>
            <span id="port-display"></span>
        </div>
        <div id="chat-box"></div>
        <div id="controls">
            <select id="target-select">
                <option value="">-- Chọn người nhận --</option>
            </select>
            <input type="text" id="msg-in" style="flex:1" placeholder="Nhập tin nhắn..."
                onkeypress="if(event.key==='Enter') send()">
            <button onclick="send()"
                style="padding:10px 20px; background:#128c7e; color:white; border:none; border-radius:20px;">GỬI</button>
        </div>
    </div>

    <script>
        let myUser = "";
        function login() {
            const u = document.getElementById('u-in').value.toLowerCase();
            const p = document.getElementById('p-in').value;
            if (!u || !p) return alert("Nhập đủ thông tin!");

            fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: u, passphrase: p })
            }).then(res => res.json()).then(data => {
                if (data.status === 'ok') {
                    myUser = u;
                    document.getElementById('login-overlay').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    document.getElementById('user-display').innerText = "User: " + u.toUpperCase();
                    setInterval(updateChat, 1500);
                    setInterval(updatePeers, 5000);
                } else { alert(data.message); }
            });
        }

        function updateChat() {
            fetch('/get_messages').then(res => res.json()).then(data => {
                const box = document.getElementById('chat-box');
                box.innerHTML = data.map(m => `
                    <div class="msg ${m.sender === myUser ? 'sent' : 'rcvd'}">
                        <strong>${m.sender.toUpperCase()}</strong><br>${m.content}
                        <div style="font-size:9px; color:gray; border-top:1px solid #eee; margin-top:5px;">VC: ${JSON.stringify(m.vc)}</div>
                    </div>
                `).join('');
                box.scrollTop = box.scrollHeight;
            });
        }

        function updatePeers() {
            fetch('/get_peers').then(res => res.json()).then(peers => {
                const sel = document.getElementById('target-select');
                const val = sel.value;
                sel.innerHTML = '<option value="">-- Chọn người nhận --</option>';
                peers.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p; opt.innerText = p.toUpperCase();
                    if (p === val) opt.selected = true;
                    sel.appendChild(opt);
                });
            });
        }

        function send() {
            const t = document.getElementById('target-select').value;
            const m = document.getElementById('msg-in').value;
            if (!t || !m) return;
            fetch('/send_chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target: t, message: m })
            }).then(() => { document.getElementById('msg-in').value = ''; updateChat(); });
        }
    </script>
</body>

</html>